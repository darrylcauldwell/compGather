{% extends "base.html" %}
{% block title %}Map - EquiCalendar{% endblock %}
{% block nav_map %}active{% endblock %}

{% block content_wrapper %}
<div style="display: flex; flex-direction: column; height: calc(100vh - 4rem);">
    <!-- Compact filter bar -->
    <div style="padding: 0.5rem 1rem; background: var(--cg-bg-card); border-bottom: 1px solid var(--cg-border); display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
        <form method="get" action="/map" style="display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; flex: 1;">
            <label class="form-label" style="margin: 0; font-size: 0.8rem;">From</label>
            <input type="date" name="date_from" value="{{ date_from }}" class="form-control" style="width: 9rem; font-size: 0.8rem; padding: 0.25rem 0.4rem;">
            <label class="form-label" style="margin: 0; font-size: 0.8rem;">To</label>
            <input type="date" name="date_to" value="{{ date_to }}" class="form-control" style="width: 9rem; font-size: 0.8rem; padding: 0.25rem 0.4rem;">
            <select name="discipline" class="form-control" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.4rem;">
                <option value="">All types</option>
                {% for d in disciplines %}
                <option value="{{ d }}"{% if discipline == d %} selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
            <select name="pony" class="form-control" style="width: auto; font-size: 0.8rem; padding: 0.25rem 0.4rem;">
                <option value="">Any pony</option>
                <option value="yes"{% if pony == 'yes' %} selected{% endif %}>Pony only</option>
                <option value="no"{% if pony == 'no' %} selected{% endif %}>Non-pony</option>
            </select>
            <input type="number" name="max_distance" value="{{ max_distance }}" placeholder="Max miles" min="0" step="10"
                   class="form-control" style="width: 6rem; font-size: 0.8rem; padding: 0.25rem 0.4rem;">
            <button type="submit" class="btn btn-sm btn-primary" style="font-size: 0.8rem; padding: 0.25rem 0.6rem;">
                <i class="bi bi-search"></i> Filter
            </button>
            <a href="/map" class="btn btn-sm btn-outline-secondary" style="font-size: 0.8rem; padding: 0.25rem 0.6rem;">Clear</a>
        </form>
        <span id="map-count" style="color: var(--cg-text-muted); font-size: 0.8rem;"></span>
    </div>

    <!-- Map container -->
    <div id="map" style="flex: 1; min-height: 0;"></div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.min.js"></script>

<script>
(function() {
    var isDark = !document.documentElement.hasAttribute('data-theme');

    var lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 18
    });
    var darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
        maxZoom: 18
    });

    var map = L.map('map', {
        center: [53.5, -1.5],
        zoom: 6,
        layers: [isDark ? darkTiles : lightTiles]
    });

    // Watch for theme changes
    var observer = new MutationObserver(function() {
        var nowDark = !document.documentElement.hasAttribute('data-theme');
        if (nowDark) {
            map.removeLayer(lightTiles);
            map.addLayer(darkTiles);
        } else {
            map.removeLayer(darkTiles);
            map.addLayer(lightTiles);
        }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    var markers = L.markerClusterGroup({ maxClusterRadius: 40 });
    map.addLayer(markers);

    // Build API URL from current page filters
    var params = new URLSearchParams(window.location.search);
    if (!params.has('date_from')) {
        params.set('date_from', new Date().toISOString().slice(0, 10));
    }

    fetch('/api/competitions?' + params.toString())
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var count = 0;
            data.forEach(function(c) {
                if (c.latitude == null || c.longitude == null) return;
                count++;
                var dateStr = c.date_start;
                if (c.date_end) dateStr += ' &ndash; ' + c.date_end;
                var popup =
                    '<strong>' + c.name + '</strong><br>' +
                    '<span style="font-size:0.85em;color:#888;">' + dateStr + '</span><br>' +
                    c.venue_name +
                    (c.discipline ? '<br><em>' + c.discipline + '</em>' : '') +
                    '<br><a href="/competitions/' + c.id + '" style="font-size:0.85em;">Details</a>' +
                    ' &middot; <a href="/api/competitions/' + c.id + '/ical" style="font-size:0.85em;">Add to calendar</a>';
                var marker = L.marker([c.latitude, c.longitude]);
                marker.bindPopup(popup);
                markers.addLayer(marker);
            });
            document.getElementById('map-count').textContent = count + ' mapped';
            if (count > 0) {
                map.fitBounds(markers.getBounds().pad(0.1));
            }
        });
})();
</script>
{% endblock %}
