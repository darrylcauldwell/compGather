{% extends "base.html" %}
{% block title %}Events - EquiCalendar{% endblock %}
{% block nav_competitions %}active{% endblock %}

{% block location_strip %}{% endblock %}

{% block content %}

<!-- Filter Panel -->
<form method="get" action="/" class="filter-form">
        <!-- Row 1: Dates + presets -->
        <div class="filter-row filter-row-dates">
            <div class="filter-field">
                <label class="form-label" for="date_from">From</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}" class="form-control" onchange="this.form.submit()">
            </div>
            <div class="filter-field">
                <label class="form-label" for="date_to">To</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}" class="form-control" onchange="this.form.submit()">
            </div>
            <div class="date-presets">
                <button type="button" class="preset-pill" data-preset="weekend">This weekend</button>
                <button type="button" class="preset-pill" data-preset="7days">Next 7 days</button>
                <button type="button" class="preset-pill" data-preset="30days">Next 30 days</button>
            </div>
            <input type="hidden" name="pony" id="pony_hidden" value="{{ pony or '' }}">
        </div>

        <!-- Row 2: Discipline, Distance, Venue, Online -->
        <div class="filter-row filter-row-selects">
            <div class="filter-field disc-field">
                <label class="form-label">Discipline</label>
                <button type="button" class="disc-toggle form-control" id="disc-toggle" onclick="toggleDiscDropdown()">
                    {% if discipline|length == 0 %}All disciplines{% elif discipline|length == 1 %}{{ discipline[0] }}{% else %}{{ discipline|length }} selected{% endif %} <i class="bi bi-chevron-down" style="font-size: 0.65rem; margin-left: auto; opacity: 0.5;"></i>
                </button>
                <div class="disc-dropdown" id="disc-dropdown">
                    {% for d in disciplines %}
                    <label class="disc-option">
                        <input type="checkbox" name="discipline" value="{{ d }}"{% if d in discipline %} checked{% endif %}>
                        <span>{{ d }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="filter-field distance-field">
                <label class="form-label">Distance from <span class="loc-postcode" id="loc-postcode-display">{{ home_postcode }}</span> <button type="button" class="loc-change" onclick="toggleLocEdit(event)">change</button> <button type="button" class="loc-change" id="geolocate-btn" onclick="useMyLocation()" title="Use my location"><i class="bi bi-crosshair"></i></button><span id="geolocate-error" style="color:var(--cg-red);font-size:0.75em;display:none;margin-left:0.25rem;"></span></label>
                <select id="max_distance_select" class="form-control" onchange="onDistanceChange()">
                    <option value="">Any distance</option>
                    <option value="10">Within 10 miles</option>
                    <option value="20">Within 20 miles</option>
                    <option value="30">Within 30 miles</option>
                    <option value="40">Within 40 miles</option>
                    <option value="50">Within 50 miles</option>
                    <option value="custom">Custom...</option>
                </select>
                <input type="hidden" name="max_distance" id="max_distance_hidden" value="{{ max_distance or '' }}">
                <input type="hidden" name="include_online" id="include_online_hidden" value="{{ include_online or '' }}">
                <div id="custom-distance-input" style="display:none; margin-top:4px; gap:4px; align-items:center;">
                    <input type="number" id="custom_distance_num" class="form-control" min="1" max="500" placeholder="miles" style="width:80px;" onkeydown="if(event.key==='Enter'){event.preventDefault();applyCustomDistance();}">
                    <button type="button" class="btn btn-primary btn-sm" onclick="applyCustomDistance()">Go</button>
                </div>
                <div class="loc-edit" id="loc-edit-form">
                    <input type="text" id="loc-postcode-input" class="form-control" placeholder="e.g. SW1A 1AA" value="{{ home_postcode }}">
                    <button type="button" class="btn btn-primary btn-sm" onclick="updatePostcode()">Update</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleLocEdit(event)">Cancel</button>
                </div>
            </div>
            <div class="filter-field venue-field">
                <label class="form-label">Venue</label>
                <button type="button" class="venue-toggle form-control" id="venue-toggle" onclick="toggleVenueDropdown()">
                    {% if venue|length == 0 %}All venues{% elif venue|length == 1 %}{{ venue[0] }}{% else %}{{ venue|length }} selected{% endif %} <i class="bi bi-chevron-down" style="font-size: 0.65rem; margin-left: auto; opacity: 0.5;"></i>
                </button>
                <div class="venue-dropdown" id="venue-dropdown">
                    <input type="text" class="venue-search" id="venue-search" placeholder="Type to filter..." oninput="filterVenueList()">
                    <div class="venue-options" id="venue-options">
                        {% for v in venue_names %}
                        <label class="venue-option">
                            <input type="checkbox" name="venue" value="{{ v }}"{% if v in venue %} checked{% endif %}>
                            <span>{{ v }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Preserve sort in form submission -->
        {% if sort and sort != 'date_asc' %}
        <input type="hidden" name="sort" value="{{ sort }}">
        {% endif %}
        <!-- Preserve event_type in form submission -->
        {% if event_type and event_type != 'all' %}
        <input type="hidden" name="event_type" value="{{ event_type }}">
        {% endif %}

    </form>

<!-- Event type toggle pills + independent toggle filters + active filter chips -->
<div class="type-pills" style="align-items: center;">
    <a href="#" class="type-pill{% if event_type == 'all' %} active{% endif %}" onclick="applyEventType(event, 'all')">All</a>
    <a href="#" class="type-pill{% if event_type == 'competitions' %} active{% endif %}" onclick="applyEventType(event, 'competitions')">Competitions</a>
    <a href="#" class="type-pill{% if event_type == 'training' %} active{% endif %}" onclick="applyEventType(event, 'training')">Training</a>
    <a href="#" class="type-pill{% if event_type == 'venue_hire' %} active{% endif %}" onclick="applyEventType(event, 'venue_hire')">Venue Hire</a>

    <!-- Active filter chips in the middle -->
    {% if active_filters %}
    <div class="filter-chips" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin: 0 0.5rem;">
        {% for label, remove_url in active_filters %}
        <a href="{{ remove_url }}" class="filter-chip">
            {{ label }} <i class="bi bi-x"></i>
        </a>
        {% endfor %}
        <a href="/" class="filter-chip">Clear all <i class="bi bi-x"></i></a>
    </div>
    {% endif %}

    <!-- Independent toggles on the right -->
    <span style="margin-left: auto; display: flex; gap: 0.375rem;">
        <a href="#" class="type-pill" onclick="togglePonyPill(event)" style="background: {% if pony == 'yes' %}var(--cg-sky-light){% else %}transparent{% endif %}; color: {% if pony == 'yes' %}var(--cg-sky){% else %}var(--cg-text){% endif %}; border: 1px solid {% if pony == 'yes' %}rgba(0,122,255,0.25){% else %}rgba(0,122,255,0.2){% endif %};">Pony</a>
        <a href="#" class="type-pill" id="online-pill-link" onclick="toggleOnlinePill(event)" style="background: {% if include_online == 'yes' %}var(--cg-sky-light){% else %}transparent{% endif %}; color: {% if include_online == 'yes' %}var(--cg-sky){% else %}var(--cg-text){% endif %}; border: 1px solid {% if include_online == 'yes' %}rgba(0,122,255,0.25){% else %}rgba(0,122,255,0.2){% endif %};">Online</a>
    </span>
</div>

<!-- Results header -->
<div class="results-header">
    <span class="results-count">
        <strong>{{ total }}</strong> event{{ 's' if total != 1 }}
    </span>
    <div class="sort-control">
        <label for="sort-select" class="sr-only">Sort by</label>
        <select id="sort-select" class="form-control" onchange="applySort(this.value)">
            <option value="date_asc"{% if sort == 'date_asc' %} selected{% endif %}>Date (soonest)</option>
            <option value="date_desc"{% if sort == 'date_desc' %} selected{% endif %}>Date (latest)</option>
            <option value="distance_asc"{% if sort == 'distance_asc' %} selected{% endif %}>Nearest first</option>
            <option value="name_asc"{% if sort == 'name_asc' %} selected{% endif %}>Name (A-Z)</option>
            <option value="venue_asc"{% if sort == 'venue_asc' %} selected{% endif %}>Venue (A-Z)</option>
            <option value="newest"{% if sort == 'newest' %} selected{% endif %}>Recently added</option>
        </select>
    </div>
</div>

<!-- Competition list -->
{% if competitions %}
<div class="comp-list">
    {% if show_date_groups %}
        {% for group_date, group_comps in date_groups %}
        <div class="date-separator" role="heading" aria-level="3">
            {{ group_date.strftime('%A %-d %B') }}{% if group_date.year != today[:4]|int %} {{ group_date.year }}{% endif %}
        </div>
        {% for comp in group_comps %}
        <a href="{{ comp.url or '#' }}" {% if comp.url %}target="_blank" rel="noopener noreferrer"{% endif %} class="comp-item{% if comp.event_type == 'training' %} event-training{% elif comp.event_type == 'venue_hire' %} event-venue-hire{% endif %}">
            <div class="ci-date">
                <span class="ci-day">{{ comp.date_start.strftime('%-d') }}</span>
                <span class="ci-mon">{{ comp.date_start.strftime('%b').upper() }}</span>
                {% if comp.date_end and comp.date_end != comp.date_start %}
                <span class="ci-range">- {{ comp.date_end.strftime('%-d %b') }}</span>
                {% endif %}
            </div>
            <div class="ci-body">
                <div class="ci-name">{{ comp.name }}</div>
                <div class="ci-meta">
                    <span class="badge-venue" data-venue="{{ comp.venue_name }}" title="Filter by venue" style="display: inline; font-size: 0.75rem; color: var(--cg-text-muted); white-space: nowrap; background: transparent; padding: 0; border: none; font-weight: normal;">{{ comp.venue_name }}</span>
                    {% if comp.distance_miles is not none %}
                    <span class="ci-distance"><i class="bi bi-geo-alt"></i> {{ "%.0f"|format(comp.distance_miles) }} mi</span>
                    {% endif %}
                    {% if comp.discipline and comp.event_type == 'competition' %}
                    <span class="badge-disc" data-disc="{{ comp.discipline|lower|replace(' ','-') }}">{{ comp.discipline }}</span>
                    {% endif %}
                    {% if comp.has_pony_classes %}
                    <span class="badge-pony">Pony</span>
                    {% endif %}
                    {% set tags = comp.tags|format_tags %}
                    {% for tag_info in tags %}
                    {% if tag_info.tag.startswith('type:') %}
                    <span class="badge-tag badge-tag-type clickable-tag" data-type="{{ tag_info.tag.replace('type:', '') }}" data-tag="{{ tag_info.tag }}">{{ tag_info.display }}</span>
                    {% endif %}
                    {% endfor %}
                    {% if comp.source %}
                    <span class="badge-source" title="Source: {{ comp.source.name }}">{{ comp.source.name }}</span>
                    {% endif %}
                    <span class="badge-ical" title="Add to calendar" data-ical="/api/competitions/{{ comp.id }}/ical"><i class="bi bi-calendar-plus"></i></span>
                </div>
            </div>
        </a>
        {% endfor %}
        {% endfor %}
    {% else %}
        {% for comp in competitions %}
        <a href="{{ comp.url or '#' }}" {% if comp.url %}target="_blank" rel="noopener noreferrer"{% endif %} class="comp-item{% if comp.event_type == 'training' %} event-training{% elif comp.event_type == 'venue_hire' %} event-venue-hire{% endif %}">
            <div class="ci-date">
                <span class="ci-day">{{ comp.date_start.strftime('%-d') }}</span>
                <span class="ci-mon">{{ comp.date_start.strftime('%b').upper() }}</span>
                {% if comp.date_end and comp.date_end != comp.date_start %}
                <span class="ci-range">- {{ comp.date_end.strftime('%-d %b') }}</span>
                {% endif %}
            </div>
            <div class="ci-body">
                <div class="ci-name">{{ comp.name }}</div>
                <div class="ci-meta">
                    <span class="badge-venue" data-venue="{{ comp.venue_name }}" title="Filter by venue" style="display: inline; font-size: 0.75rem; color: var(--cg-text-muted); white-space: nowrap; background: transparent; padding: 0; border: none; font-weight: normal;">{{ comp.venue_name }}</span>
                    {% if comp.distance_miles is not none %}
                    <span class="ci-distance"><i class="bi bi-geo-alt"></i> {{ "%.0f"|format(comp.distance_miles) }} mi</span>
                    {% endif %}
                    {% if comp.discipline and comp.event_type == 'competition' %}
                    <span class="badge-disc" data-disc="{{ comp.discipline|lower|replace(' ','-') }}">{{ comp.discipline }}</span>
                    {% endif %}
                    {% if comp.has_pony_classes %}
                    <span class="badge-pony">Pony</span>
                    {% endif %}
                    {% set tags = comp.tags|format_tags %}
                    {% for tag_info in tags %}
                    {% if tag_info.tag.startswith('type:') %}
                    <span class="badge-tag badge-tag-type clickable-tag" data-type="{{ tag_info.tag.replace('type:', '') }}" data-tag="{{ tag_info.tag }}">{{ tag_info.display }}</span>
                    {% endif %}
                    {% endfor %}
                    {% if comp.source %}
                    <span class="badge-source" title="Source: {{ comp.source.name }}">{{ comp.source.name }}</span>
                    {% endif %}
                    <span class="badge-ical" title="Add to calendar" data-ical="/api/competitions/{{ comp.id }}/ical"><i class="bi bi-calendar-plus"></i></span>
                </div>
            </div>
        </a>
        {% endfor %}
    {% endif %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="pagination" aria-label="Pagination">
    {% if prev_url %}
    <a href="{{ prev_url }}" class="page-btn" aria-label="Previous page">
        <i class="bi bi-chevron-left"></i>
    </a>
    {% else %}
    <span class="page-btn disabled" aria-hidden="true">
        <i class="bi bi-chevron-left"></i>
    </span>
    {% endif %}
    <span class="page-info">{{ page }} / {{ total_pages }}</span>
    {% if next_url %}
    <a href="{{ next_url }}" class="page-btn" aria-label="Next page">
        <i class="bi bi-chevron-right"></i>
    </a>
    {% else %}
    <span class="page-btn disabled" aria-hidden="true">
        <i class="bi bi-chevron-right"></i>
    </span>
    {% endif %}
</nav>
{% endif %}

{% else %}
<!-- Empty state -->
<div class="empty-state">
    <div class="icon"><i class="bi bi-calendar-x"></i></div>
    {% if discipline and max_distance %}
    <p>No {{ discipline|join(' / ') }} competitions within {{ max_distance }} miles</p>
    <p>Try increasing your distance or choosing a different discipline.</p>
    {% elif q %}
    <p>No competitions matching "{{ q }}"</p>
    <p>Try a different search term or clear your filters.</p>
    {% else %}
    <p>No competitions found</p>
    <p>Try adjusting your filters or adding sources and running a scan.</p>
    {% endif %}
    <a href="/" class="btn btn-outline-primary" style="margin-top: 1rem;">Clear all filters</a>
</div>
{% endif %}

<script>
/* Distance filter with custom option */
(function initDistanceSelect() {
    var val = document.getElementById('max_distance_hidden').value;
    var sel = document.getElementById('max_distance_select');
    var presets = ['', '10', '20', '30', '40', '50'];
    if (val && !presets.includes(val)) {
        sel.value = 'custom';
        var customDiv = document.getElementById('custom-distance-input');
        customDiv.style.display = 'flex';
        document.getElementById('custom_distance_num').value = val;
    } else {
        sel.value = val;
    }
})();

function onDistanceChange() {
    var sel = document.getElementById('max_distance_select');
    var customDiv = document.getElementById('custom-distance-input');
    if (sel.value === 'custom') {
        customDiv.style.display = 'flex';
        document.getElementById('custom_distance_num').focus();
    } else {
        customDiv.style.display = 'none';
        document.getElementById('max_distance_hidden').value = sel.value;
        // When distance is set, auto-disable online events (since distance implies local travel)
        // User can still toggle it back on if desired
        if (sel.value) {
            document.getElementById('include_online_hidden').value = '';
        }
        sel.closest('form').submit();
    }
}

function applyCustomDistance() {
    var val = document.getElementById('custom_distance_num').value;
    var num = parseInt(val, 10);
    if (!val || isNaN(num) || num < 1) return;
    document.getElementById('max_distance_hidden').value = num;
    // Auto-disable online events when custom distance is applied
    document.getElementById('include_online_hidden').value = '';
    document.getElementById('max_distance_select').closest('form').submit();
}

function toggleOnlineFilter() {
    var checkbox = document.getElementById('include_online_checkbox');
    var maxDist = document.getElementById('max_distance_hidden').value;
    var url = new URL(window.location);
    if (checkbox.checked) {
        url.searchParams.set('include_online', 'yes');
    } else {
        url.searchParams.delete('include_online');
    }
    window.location = url.toString();
}

function togglePonyPill(e) {
    e.preventDefault();
    var ponyVal = document.getElementById('pony_hidden').value;
    document.getElementById('pony_hidden').value = ponyVal === 'yes' ? '' : 'yes';
    document.querySelector('form').submit();
}

function toggleOnlinePill(e) {
    e.preventDefault();
    var onlineVal = document.getElementById('include_online_hidden').value;
    document.getElementById('include_online_hidden').value = onlineVal === 'yes' ? '' : 'yes';
    document.querySelector('form').submit();
}

/* Online pill is now always visible, user can toggle it at any time */

/* Location postcode edit */
function toggleLocEdit(e) {
    if (e) e.preventDefault();
    var form = document.getElementById('loc-edit-form');
    form.classList.toggle('visible');
    if (form.classList.contains('visible')) {
        document.getElementById('loc-postcode-input').focus();
    }
}
async function updatePostcode() {
    var postcode = document.getElementById('loc-postcode-input').value.trim();
    if (!postcode) return;
    try {
        var resp = await fetch('/api/competitions/update-postcode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({postcode: postcode})
        });
        if (resp.ok) {
            location.reload();
        } else {
            var data = await resp.json();
            alert(data.detail || 'Invalid postcode');
        }
    } catch (e) {
        alert('Failed to update postcode');
    }
}

async function useMyLocation() {
    if (!navigator.geolocation) {
        showGeoError('Geolocation not supported by this browser.');
        return;
    }
    var btn = document.getElementById('geolocate-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat" style="display:inline-block;animation:spin 1s linear infinite;"></i>';
    document.getElementById('geolocate-error').style.display = 'none';

    navigator.geolocation.getCurrentPosition(
        async function(pos) {
            try {
                var resp = await fetch('/api/competitions/geolocate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: pos.coords.latitude, lng: pos.coords.longitude})
                });
                if (resp.ok) {
                    location.reload();
                } else {
                    var data = await resp.json().catch(function() { return {}; });
                    showGeoError(data.detail || 'Could not find a UK postcode for your location.');
                    resetGeoBtn();
                }
            } catch (e) {
                showGeoError('Request failed. Please try again.');
                resetGeoBtn();
            }
        },
        function(err) {
            var msgs = {1: 'Location access denied.', 2: 'Location unavailable.', 3: 'Location request timed out.'};
            showGeoError(msgs[err.code] || 'Location error.');
            resetGeoBtn();
        },
        {timeout: 10000, maximumAge: 60000}
    );

    function showGeoError(msg) {
        var el = document.getElementById('geolocate-error');
        el.textContent = msg; el.style.display = 'inline';
    }
    function resetGeoBtn() {
        var btn = document.getElementById('geolocate-btn');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-crosshair"></i>';
    }
}

function applySort(value) {
    var url = new URL(window.location);
    if (value && value !== 'date_asc') {
        url.searchParams.set('sort', value);
    } else {
        url.searchParams.delete('sort');
    }
    url.searchParams.delete('page');
    window.location = url.toString();
}

function applyEventType(e, value) {
    e.preventDefault();
    var url = new URL(window.location);
    if (value && value !== 'all') {
        url.searchParams.set('event_type', value);
    } else {
        url.searchParams.delete('event_type');
    }
    url.searchParams.delete('page');
    window.location = url.toString();
}

/* Quick date presets */
document.querySelectorAll('.preset-pill').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var preset = this.dataset.preset;
        var today = new Date();
        var fromInput = document.getElementById('date_from');
        var toInput = document.getElementById('date_to');

        function fmt(d) {
            return d.getFullYear() + '-' +
                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                String(d.getDate()).padStart(2, '0');
        }

        if (preset === 'weekend') {
            /* Find next Saturday */
            var sat = new Date(today);
            var dayOfWeek = sat.getDay();
            var daysUntilSat = (6 - dayOfWeek + 7) % 7;
            if (daysUntilSat === 0 && today.getDay() === 6) daysUntilSat = 0;
            else if (daysUntilSat === 0) daysUntilSat = 7;
            /* If today is Saturday or Sunday, use this weekend */
            if (dayOfWeek === 0) { /* Sunday */
                sat.setDate(sat.getDate() - 1);
            } else if (dayOfWeek !== 6) {
                sat.setDate(sat.getDate() + daysUntilSat);
            }
            var sun = new Date(sat);
            sun.setDate(sun.getDate() + 1);
            fromInput.value = fmt(sat);
            toInput.value = fmt(sun);
        } else if (preset === '7days') {
            fromInput.value = fmt(today);
            var end = new Date(today);
            end.setDate(end.getDate() + 7);
            toInput.value = fmt(end);
        } else if (preset === '30days') {
            fromInput.value = fmt(today);
            var end30 = new Date(today);
            end30.setDate(end30.getDate() + 30);
            toInput.value = fmt(end30);
        }

        /* Mark active preset and submit */
        document.querySelectorAll('.preset-pill').forEach(function(p) { p.classList.remove('active'); });
        this.classList.add('active');
        document.querySelector('.filter-form').submit();
    });
});

/* Discipline multi-select dropdown */
function toggleDiscDropdown() {
    var dd = document.getElementById('disc-dropdown');
    dd.classList.toggle('open');
}

function updateDiscLabel() {
    var checked = document.querySelectorAll('#disc-dropdown input[type="checkbox"]:checked');
    var btn = document.getElementById('disc-toggle');
    var icon = btn.querySelector('i');
    var text;
    if (checked.length === 0) {
        text = 'All disciplines';
    } else if (checked.length === 1) {
        text = checked[0].value;
    } else {
        text = checked.length + ' selected';
    }
    btn.textContent = text + ' ';
    btn.appendChild(icon);
}

document.querySelectorAll('#disc-dropdown input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', function() {
        updateDiscLabel();
        document.querySelector('.filter-form').submit();
    });
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('.disc-field')) {
        document.getElementById('disc-dropdown').classList.remove('open');
    }
    if (!e.target.closest('.venue-field')) {
        document.getElementById('venue-dropdown').classList.remove('open');
    }
});

/* Venue multi-select dropdown with search */
function toggleVenueDropdown() {
    var dd = document.getElementById('venue-dropdown');
    dd.classList.toggle('open');
    if (dd.classList.contains('open')) {
        document.getElementById('venue-search').focus();
    }
}

function filterVenueList() {
    var query = document.getElementById('venue-search').value.toLowerCase();
    document.querySelectorAll('#venue-options .venue-option').forEach(function(label) {
        var text = label.querySelector('span').textContent.toLowerCase();
        label.style.display = text.indexOf(query) !== -1 ? '' : 'none';
    });
}

function updateVenueLabel() {
    var checked = document.querySelectorAll('#venue-options input[type="checkbox"]:checked');
    var btn = document.getElementById('venue-toggle');
    var icon = btn.querySelector('i');
    var text;
    if (checked.length === 0) {
        text = 'All venues';
    } else if (checked.length === 1) {
        text = checked[0].value;
    } else {
        text = checked.length + ' selected';
    }
    btn.textContent = text + ' ';
    btn.appendChild(icon);
}

document.querySelectorAll('#venue-options input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', function() {
        updateVenueLabel();
        document.querySelector('.filter-form').submit();
    });
});

/* Collapse filter panel after first use on mobile */
(function() {
    if (window.innerWidth >= 768) return;
    var panel = document.querySelector('.filter-panel');
    if (!panel) return;
    var hasInteracted = localStorage.getItem('cg-filters-used');
    if (hasInteracted) {
        panel.removeAttribute('open');
    }
    panel.querySelector('form').addEventListener('submit', function() {
        localStorage.setItem('cg-filters-used', '1');
    });
})();

/* Clickable tags for filtering */
document.querySelectorAll('.clickable-tag').forEach(function(tag) {
    tag.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var url = new URL(window.location);
        var tagValue = this.dataset.tag;
        var currentTags = url.searchParams.getAll('tag');

        /* Check if tag is already selected */
        if (!currentTags.includes(tagValue)) {
            url.searchParams.append('tag', tagValue);
        }
        url.searchParams.delete('page');
        window.location = url.toString();
    });
    tag.style.cursor = 'pointer';
    tag.style.opacity = '0.8';
    tag.addEventListener('mouseenter', function() {
        this.style.opacity = '1';
    });
    tag.addEventListener('mouseleave', function() {
        this.style.opacity = '0.8';
    });
});

/* Clickable discipline badges for filtering */
document.querySelectorAll('.badge-disc').forEach(function(badge) {
    badge.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var url = new URL(window.location);
        var discipline = this.textContent.trim();
        var currentDisciplines = url.searchParams.getAll('discipline');

        /* Check if discipline is already selected */
        if (!currentDisciplines.includes(discipline)) {
            url.searchParams.append('discipline', discipline);
        }
        url.searchParams.delete('page');
        window.location = url.toString();
    });
    badge.style.cursor = 'pointer';
    badge.style.opacity = '0.8';
    badge.addEventListener('mouseenter', function() {
        this.style.opacity = '1';
    });
    badge.addEventListener('mouseleave', function() {
        this.style.opacity = '0.8';
    });
});

/* Clickable Pony badge for filtering */
document.querySelectorAll('.badge-pony').forEach(function(badge) {
    badge.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var url = new URL(window.location);
        url.searchParams.set('pony', 'yes');
        url.searchParams.delete('page');
        window.location = url.toString();
    });
    badge.style.cursor = 'pointer';
    badge.style.opacity = '0.8';
    badge.addEventListener('mouseenter', function() {
        this.style.opacity = '1';
    });
    badge.addEventListener('mouseleave', function() {
        this.style.opacity = '0.8';
    });
});

/* Clickable source parser badge for filtering */
document.querySelectorAll('.badge-source').forEach(function(badge) {
    badge.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var url = new URL(window.location);
        var source = this.textContent.trim();
        var currentSources = url.searchParams.getAll('source');

        /* Check if source is already selected */
        if (!currentSources.includes(source)) {
            url.searchParams.append('source', source);
        }
        url.searchParams.delete('page');
        window.location = url.toString();
    });
    badge.style.cursor = 'pointer';
    badge.style.opacity = '0.8';
    badge.addEventListener('mouseenter', function() {
        this.style.opacity = '1';
    });
    badge.addEventListener('mouseleave', function() {
        this.style.opacity = '0.8';
    });
});

/* Clickable venue badge for filtering */
document.querySelectorAll('.badge-venue').forEach(function(badge) {
    badge.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var url = new URL(window.location);
        var venue = this.dataset.venue;
        var currentVenues = url.searchParams.getAll('venue');

        /* Check if venue is already selected */
        if (!currentVenues.includes(venue)) {
            url.searchParams.append('venue', venue);
        }
        url.searchParams.delete('page');
        window.location = url.toString();
    });
    badge.style.cursor = 'pointer';
    badge.style.opacity = '0.8';
    badge.addEventListener('mouseenter', function() {
        this.style.opacity = '1';
    });
    badge.addEventListener('mouseleave', function() {
        this.style.opacity = '0.8';
    });
});

/* Calendar download buttons */
document.querySelectorAll('.badge-ical').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.location.href = this.dataset.ical;
    });
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
