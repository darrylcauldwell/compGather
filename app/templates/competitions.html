{% extends "base.html" %}
{% block title %}Events - EquiCalendar{% endblock %}
{% block nav_competitions %}active{% endblock %}

{% block location_strip %}{% endblock %}

{% block content %}

{% set sort_options = [
    ('date_asc', 'Date (soonest)'),
    ('date_desc', 'Date (latest)'),
    ('distance_asc', 'Nearest first'),
    ('name_asc', 'Name (A-Z)'),
    ('venue_asc', 'Venue (A-Z)'),
    ('newest', 'Recently added')
] %}

<!-- Single form wrapping all filters — hidden fields preserve state across submissions -->
<form method="get" action="/" class="filter-form" id="filter-form">
    <input type="hidden" name="max_distance" id="max_distance_hidden" value="{{ max_distance or '' }}">
    <input type="hidden" name="include_online" id="include_online_hidden" value="{{ include_online or '' }}">
    <input type="hidden" name="postcode" id="postcode_hidden" value="{{ postcode or '' }}">
    {% if sort and sort != 'date_asc' %}
    <input type="hidden" name="sort" id="sort_hidden" value="{{ sort }}">
    {% endif %}
    {% if event_type and event_type != 'all' %}
    <input type="hidden" name="event_type" id="event_type_hidden" value="{{ event_type }}">
    {% endif %}

    <!-- ===== DESKTOP FILTER BAR ===== -->
    <div class="filter-bar-desktop">
        <!-- All filters in one row — flex-wrap handles line-breaking -->
        <div class="filter-row">
            <input type="date" id="date_from" name="date_from" value="{{ date_from }}" class="filter-date-input" onchange="this.form.submit()">
            <span style="color:var(--cg-text-muted);font-size:0.75rem;">to</span>
            <input type="date" id="date_to" name="date_to" value="{{ date_to }}" class="filter-date-input" onchange="this.form.submit()">
            <button type="button" class="filter-pill" data-preset="weekend">This weekend</button>
            <button type="button" class="filter-pill" data-preset="7days">Next 7 days</button>
            <button type="button" class="filter-pill" data-preset="30days">Next 30 days</button>
            <!-- Event Type dropdown -->
            <div class="pill-container" id="event-type-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('event-type-dropdown')">
                    {% if event_type == 'competitions' %}Competitions{% elif event_type == 'training' %}Training{% elif event_type == 'show' %}Shows{% elif event_type == 'venue_hire' %}Venue Hire{% elif event_type == 'social' %}Social{% elif event_type == 'other' %}Other{% else %}Type{% endif %}
                    <i class="bi bi-chevron-down pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="event-type-dropdown">
                    <div class="pill-dropdown-options">
                        {% for val, label in [('all', 'All types'), ('competitions', 'Competitions'), ('training', 'Training'), ('show', 'Shows'), ('venue_hire', 'Venue Hire'), ('social', 'Social'), ('other', 'Other')] %}
                        <label class="pill-dropdown-option" onclick="applyEventType(event, '{{ val }}')">
                            <span>{{ label }}</span>
                            {% if event_type == val or (val == 'all' and event_type == 'all') %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Discipline dropdown -->
            <div class="pill-container" id="discipline-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('discipline-dropdown')">
                    {% if discipline|length == 0 %}Discipline{% elif discipline|length == 1 %}{{ discipline[0] }}{% else %}Discipline <span class="pill-count">{{ discipline|length }}</span>{% endif %}
                    <i class="bi bi-chevron-down pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="discipline-dropdown">
                    <div class="pill-dropdown-options">
                        {% for d in disciplines %}
                        <label class="pill-dropdown-option">
                            <input type="checkbox" name="discipline" value="{{ d }}"{% if d in discipline %} checked{% endif %}>
                            <span>{{ d }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Venue dropdown -->
            <div class="pill-container" id="venue-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('venue-dropdown')">
                    {% if venue|length == 0 %}Venue{% elif venue|length == 1 %}{{ venue[0] }}{% else %}Venue <span class="pill-count">{{ venue|length }}</span>{% endif %}
                    <i class="bi bi-chevron-down pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="venue-dropdown">
                    <input type="text" class="pill-dropdown-search" id="venue-search" placeholder="Type to filter..." oninput="filterDropdownList('venue-dropdown')">
                    <div class="pill-dropdown-options" id="venue-options">
                        {% if 'Online' in venue_names %}
                        <label class="pill-dropdown-option" data-pinned="true">
                            <input type="checkbox" name="venue" value="Online"{% if 'Online' in venue %} checked{% endif %}>
                            <span>Online</span>
                        </label>
                        <hr style="margin:0.25rem 0;border-color:var(--cg-border);opacity:0.3;">
                        {% endif %}
                        {% for v in venue_names if v != 'Online' %}
                        <label class="pill-dropdown-option">
                            <input type="checkbox" name="venue" value="{{ v }}"{% if v in venue %} checked{% endif %}>
                            <span>{{ v }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Affiliation dropdown -->
            {% if affiliations_available %}
            <div class="pill-container" id="affiliation-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('affiliation-dropdown')">
                    {% if affiliation|length == 0 %}Affiliation{% elif affiliation|length == 1 %}{{ affiliation[0]|replace('-', ' ')|title }}{% else %}Affiliation <span class="pill-count">{{ affiliation|length }}</span>{% endif %}
                    <i class="bi bi-chevron-down pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="affiliation-dropdown">
                    <div class="pill-dropdown-options">
                        {% for a in affiliations_available %}
                        <label class="pill-dropdown-option">
                            <input type="checkbox" name="affiliation" value="{{ a }}"{% if a in affiliation %} checked{% endif %}>
                            <span>{{ a|replace('-', ' ')|title }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Distance dropdown -->
            <div class="pill-container" id="distance-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('distance-dropdown')">
                    {% if max_distance %}Within {{ max_distance }} mi{% else %}Distance{% endif %}
                    <i class="bi bi-chevron-down pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="distance-dropdown" style="min-width:14rem;">
                    <div class="pill-dropdown-options">
                        <label class="pill-dropdown-option" onclick="setDistance('')">
                            <span>Any distance</span>
                            {% if not max_distance %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
                        </label>
                        {% for d in [10, 20, 30, 40, 50] %}
                        <label class="pill-dropdown-option" onclick="setDistance('{{ d }}')">
                            <span>Within {{ d }} miles</span>
                            {% if max_distance == d|string %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
                        </label>
                        {% endfor %}
                        <div style="padding:0.35rem 0.5rem;">
                            <div style="display:flex;gap:0.25rem;align-items:center;">
                                <input type="number" id="custom_distance_num" class="filter-date-input" min="1" max="500" placeholder="Custom mi" style="width:6rem;border-radius:0.375rem;" value="{{ max_distance if max_distance and max_distance not in ['10','20','30','40','50'] else '' }}" onkeydown="if(event.key==='Enter'){event.preventDefault();applyCustomDistance();}">
                                <button type="button" class="btn btn-primary btn-sm" onclick="applyCustomDistance()">Go</button>
                            </div>
                        </div>
                    </div>
                    <div style="border-top:1px solid var(--cg-border);padding:0.5rem;">
                        <div class="distance-loc-bar">
                            <span>from</span>
                            <span class="loc-postcode" id="loc-postcode-display">{{ postcode if postcode else 'Set postcode' }}</span>
                            <button type="button" class="loc-change" onclick="toggleLocEdit(event)">{% if postcode %}change{% else %}set{% endif %}</button>
                            <button type="button" class="loc-change" id="geolocate-btn" onclick="useMyLocation()" title="Use my location"><i class="bi bi-crosshair"></i></button>
                            <span id="geolocate-error" style="color:var(--cg-red);font-size:0.75em;display:none;margin-left:0.25rem;"></span>
                        </div>
                        <div class="loc-edit{% if not postcode %} visible{% endif %}" id="loc-edit-form">
                            <input type="text" id="loc-postcode-input" placeholder="e.g. SW1A 1AA" value="{{ postcode or '' }}">
                            <button type="button" class="btn btn-primary btn-sm" onclick="updatePostcode()">Update</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleLocEdit(event)">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sort pill -->
            <div class="pill-container" id="sort-container">
                <button type="button" class="filter-pill" onclick="toggleDropdown('sort-dropdown')">
                    {% if sort == 'date_desc' %}Latest{% elif sort == 'distance_asc' %}Nearest{% elif sort == 'name_asc' %}A-Z{% elif sort == 'venue_asc' %}Venue{% elif sort == 'newest' %}New{% else %}Soonest{% endif %}
                    <i class="bi bi-arrow-down-up pill-chevron"></i>
                </button>
                <div class="pill-dropdown" id="sort-dropdown" style="right:0;left:auto;">
                    <div class="pill-dropdown-options">
                        {% for val, label in sort_options %}
                        <label class="pill-dropdown-option" onclick="applySort('{{ val }}')">
                            <span>{{ label }}</span>
                            {% if sort == val %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Event count -->
            <span class="results-count" style="margin-left:auto;">
                <strong>{{ total }}</strong> event{{ 's' if total != 1 }}
            </span>
        </div>

        <!-- Active filter chips -->
        {% if active_filters %}
        <div class="filter-row">
            <div class="filter-chips" style="display:flex;flex-wrap:wrap;gap:0.375rem;margin:0;">
                {% for label, remove_url in active_filters %}
                <a href="{{ remove_url }}" class="filter-chip">{{ label }} <i class="bi bi-x"></i></a>
                {% endfor %}
                <a href="/" class="filter-chip">Clear all <i class="bi bi-x"></i></a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ===== MOBILE TRIGGER BAR ===== -->
    <div class="mobile-filter-trigger">
        <button type="button" class="filter-pill" onclick="openFilterDrawer()" style="flex:1;">
            <i class="bi bi-funnel"></i> Filters{% if filter_count %} <span class="pill-count">{{ filter_count }}</span>{% endif %}
        </button>
        <div class="pill-container" id="mobile-sort-container">
            <button type="button" class="filter-pill" onclick="toggleDropdown('mobile-sort-dropdown')">
                <i class="bi bi-arrow-down-up"></i> Sort
            </button>
            <div class="pill-dropdown" id="mobile-sort-dropdown" style="right:0;left:auto;">
                <div class="pill-dropdown-options">
                    {% for val, label in sort_options %}
                    <label class="pill-dropdown-option" onclick="applySort('{{ val }}')">
                        <span>{{ label }}</span>
                        {% if sort == val %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile active chips (always visible) -->
    {% if active_filters %}
    <div class="filter-chips" style="display:none;flex-wrap:wrap;gap:0.375rem;margin-bottom:0.5rem;" id="mobile-chips">
        {% for label, remove_url in active_filters %}
        <a href="{{ remove_url }}" class="filter-chip">{{ label }} <i class="bi bi-x"></i></a>
        {% endfor %}
        <a href="/" class="filter-chip">Clear all <i class="bi bi-x"></i></a>
    </div>
    {% endif %}
</form>

<!-- ===== MOBILE FILTER DRAWER ===== -->
<div class="filter-drawer-backdrop" id="filter-drawer-backdrop" onclick="closeFilterDrawer()"></div>
<div class="filter-drawer" id="filter-drawer">
    <div class="filter-drawer-handle"></div>

    <div class="filter-drawer-section">Date Range</div>
    <div class="filter-row">
        <input type="date" class="filter-date-input" id="m-date-from" value="{{ date_from }}" style="flex:1;">
        <span style="color:var(--cg-text-muted);font-size:0.75rem;">to</span>
        <input type="date" class="filter-date-input" id="m-date-to" value="{{ date_to }}" style="flex:1;">
    </div>
    <div class="filter-row" style="margin-top:0.375rem;">
        <button type="button" class="filter-pill" data-preset="weekend">This weekend</button>
        <button type="button" class="filter-pill" data-preset="7days">Next 7 days</button>
        <button type="button" class="filter-pill" data-preset="30days">Next 30 days</button>
    </div>

    <div class="filter-drawer-section">Event Type</div>
    <div class="pill-dropdown-options" style="max-height:12rem;overflow-y:auto;padding:0;">
        {% for val, label in [('all', 'All types'), ('competitions', 'Competitions'), ('training', 'Training'), ('show', 'Shows'), ('venue_hire', 'Venue Hire'), ('social', 'Social'), ('other', 'Other')] %}
        <label class="pill-dropdown-option" onclick="applyEventType(event, '{{ val }}')">
            <span>{{ label }}</span>
            {% if event_type == val or (val == 'all' and event_type == 'all') %}<i class="bi bi-check" style="margin-left:auto;color:var(--cg-sky);"></i>{% endif %}
        </label>
        {% endfor %}
    </div>

    <div class="filter-drawer-section">Discipline</div>
    <div class="pill-dropdown-options" id="m-discipline-options" style="max-height:12rem;overflow-y:auto;padding:0;">
        {% for d in disciplines %}
        <label class="pill-dropdown-option">
            <input type="checkbox" class="m-discipline-cb" value="{{ d }}"{% if d in discipline %} checked{% endif %}>
            <span>{{ d }}</span>
        </label>
        {% endfor %}
    </div>

    <div class="filter-drawer-section">Venue</div>
    <input type="text" class="pill-dropdown-search" id="m-venue-search" placeholder="Type to filter..." oninput="filterDropdownList('m-venue-options')" style="margin-bottom:0.25rem;">
    <div class="pill-dropdown-options" id="m-venue-options" style="max-height:12rem;overflow-y:auto;padding:0;">
        {% if 'Online' in venue_names %}
        <label class="pill-dropdown-option" data-pinned="true">
            <input type="checkbox" class="m-venue-cb" value="Online"{% if 'Online' in venue %} checked{% endif %}>
            <span>Online</span>
        </label>
        <hr style="margin:0.25rem 0;border-color:var(--cg-border);opacity:0.3;">
        {% endif %}
        {% for v in venue_names if v != 'Online' %}
        <label class="pill-dropdown-option">
            <input type="checkbox" class="m-venue-cb" value="{{ v }}"{% if v in venue %} checked{% endif %}>
            <span>{{ v }}</span>
        </label>
        {% endfor %}
    </div>

    {% if affiliations_available %}
    <div class="filter-drawer-section">Affiliation</div>
    <div class="pill-dropdown-options" id="m-affiliation-options" style="max-height:10rem;overflow-y:auto;padding:0;">
        {% for a in affiliations_available %}
        <label class="pill-dropdown-option">
            <input type="checkbox" class="m-affiliation-cb" value="{{ a }}"{% if a in affiliation %} checked{% endif %}>
            <span>{{ a|replace('-', ' ')|title }}</span>
        </label>
        {% endfor %}
    </div>
    {% endif %}

    <div class="filter-drawer-section">Distance</div>
    <div class="filter-row type-pills-row">
        <button type="button" class="filter-pill{% if not max_distance %} active{% endif %}" onclick="setDistance('')">Any</button>
        {% for d in [10, 20, 30, 50] %}
        <button type="button" class="filter-pill{% if max_distance == d|string %} active{% endif %}" onclick="setDistance('{{ d }}')">{{ d }} mi</button>
        {% endfor %}
    </div>
    <div class="distance-loc-bar" style="margin-top:0.25rem;">
        <span>from</span>
        <span class="loc-postcode">{{ postcode if postcode else 'Set postcode' }}</span>
    </div>

    <div class="filter-drawer-actions">
        <button type="button" class="btn btn-outline-secondary" onclick="clearAllFilters()">Clear all</button>
        <button type="button" class="btn btn-primary" onclick="applyMobileFilters()">Apply</button>
    </div>
</div>

<!-- Competition list -->
{% macro render_comp(comp) %}
<a href="{{ comp.url or '#' }}" {% if comp.url %}target="_blank" rel="noopener noreferrer"{% endif %} class="comp-item{% if comp.event_type == 'training' %} event-training{% elif comp.event_type == 'venue_hire' %} event-venue-hire{% elif comp.event_type == 'show' %} event-show{% elif comp.event_type == 'social' %} event-social{% elif comp.event_type == 'other' %} event-other{% endif %}">
    <div class="ci-date">
        <span class="ci-day">{{ comp.date_start.strftime('%-d') }}</span>
        <span class="ci-mon">{{ comp.date_start.strftime('%b').upper() }}</span>
        {% if comp.date_end and comp.date_end != comp.date_start %}
        <span class="ci-range">- {{ comp.date_end.strftime('%-d %b') }}</span>
        {% endif %}
    </div>
    <div class="ci-body">
        <div class="ci-name">{{ comp.name }}</div>
        <div class="ci-meta">
            <span class="badge-venue" data-venue="{{ comp.venue_name }}" title="Filter by venue">{{ comp.venue_name }}</span>
            {% if comp.distance_miles is not none %}
            <span class="ci-distance"><i class="bi bi-geo-alt"></i> {{ "%.0f"|format(comp.distance_miles) }} mi</span>
            {% endif %}
            {% set tags = comp.tags|format_tags %}
            {% for tag_info in tags %}
            {% if tag_info.tag.startswith('discipline:') %}
            <span class="badge-disc" data-disc="{{ tag_info.tag.replace('discipline:', '') }}">{{ tag_info.display }}</span>
            {% elif tag_info.tag.startswith('type:') %}
            <span class="badge-tag badge-tag-type clickable-tag" data-type="{{ tag_info.tag.replace('type:', '') }}" data-tag="{{ tag_info.tag }}">{{ tag_info.display }}</span>
            {% elif tag_info.tag.startswith('affiliation:') %}
            <span class="badge-tag badge-tag-affiliation clickable-tag" data-tag="{{ tag_info.tag }}">{{ tag_info.display }}</span>
            {% endif %}
            {% endfor %}
            {% if comp.source %}
            <span class="badge-source" title="Source: {{ comp.source.name }}">{{ comp.source.name }}</span>
            {% endif %}
            <span class="badge-ical" title="Add to calendar" data-ical="/api/competitions/{{ comp.id }}/ical"><i class="bi bi-calendar-plus"></i></span>
        </div>
    </div>
</a>
{% endmacro %}

{% if competitions %}
<div class="comp-list">
    {% if show_date_groups %}
        {% for group_date, group_comps in date_groups %}
        <div class="date-separator" role="heading" aria-level="3">
            {{ group_date.strftime('%A %-d %B') }}{% if group_date.year != today[:4]|int %} {{ group_date.year }}{% endif %}
        </div>
        {% for comp in group_comps %}
        {{ render_comp(comp) }}
        {% endfor %}
        {% endfor %}
    {% else %}
        {% for comp in competitions %}
        {{ render_comp(comp) }}
        {% endfor %}
    {% endif %}
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="pagination" aria-label="Pagination">
    {% if prev_url %}
    <a href="{{ prev_url }}" class="page-btn" aria-label="Previous page">
        <i class="bi bi-chevron-left"></i>
    </a>
    {% else %}
    <span class="page-btn disabled" aria-hidden="true">
        <i class="bi bi-chevron-left"></i>
    </span>
    {% endif %}
    <span class="page-info">{{ page }} / {{ total_pages }}</span>
    {% if next_url %}
    <a href="{{ next_url }}" class="page-btn" aria-label="Next page">
        <i class="bi bi-chevron-right"></i>
    </a>
    {% else %}
    <span class="page-btn disabled" aria-hidden="true">
        <i class="bi bi-chevron-right"></i>
    </span>
    {% endif %}
</nav>
{% endif %}

{% else %}
<!-- Empty state -->
<div class="empty-state">
    <div class="icon"><i class="bi bi-calendar-x"></i></div>
    {% if discipline and max_distance %}
    <p>No {{ discipline|join(' / ') }} competitions within {{ max_distance }} miles</p>
    <p>Try increasing your distance or choosing a different discipline.</p>
    {% elif q %}
    <p>No competitions matching "{{ q }}"</p>
    <p>Try a different search term or clear your filters.</p>
    {% else %}
    <p>No competitions found</p>
    <p>Try adjusting your filters or adding sources and running a scan.</p>
    {% endif %}
    <a href="/" class="btn btn-outline-primary" style="margin-top: 1rem;">Clear all filters</a>
</div>
{% endif %}

<script>
/* ========================================
   localStorage postcode restore
   ======================================== */
(function() {
    var params = new URLSearchParams(window.location.search);
    if (!params.get('postcode')) {
        var saved = localStorage.getItem('cg_postcode');
        if (saved) {
            params.set('postcode', saved);
            window.location.search = params.toString();
        }
    } else {
        // Sync URL postcode to localStorage
        localStorage.setItem('cg_postcode', params.get('postcode'));
    }
})();

/* ========================================
   Unified dropdown system
   ======================================== */
function toggleDropdown(id) {
    var allDropdowns = document.querySelectorAll('.pill-dropdown');
    allDropdowns.forEach(function(dd) {
        if (dd.id !== id) dd.classList.remove('open');
    });
    var target = document.getElementById(id);
    target.classList.toggle('open');
    /* Focus search input if present */
    if (target.classList.contains('open')) {
        var search = target.querySelector('.pill-dropdown-search');
        if (search) search.focus();
    }
}

/* Click-outside handler — closes all open dropdowns */
document.addEventListener('click', function(e) {
    if (!e.target.closest('.pill-container')) {
        document.querySelectorAll('.pill-dropdown').forEach(function(dd) {
            dd.classList.remove('open');
        });
    }
});

/* Auto-submit on checkbox change in any pill dropdown */
document.querySelectorAll('.filter-bar-desktop .pill-dropdown input[type="checkbox"]').forEach(function(cb) {
    cb.addEventListener('change', function() {
        document.getElementById('filter-form').submit();
    });
});

/* Filter dropdown list (search) */
function filterDropdownList(dropdownId) {
    var container = document.getElementById(dropdownId);
    var searchInput = container.querySelector('.pill-dropdown-search') || document.getElementById('m-venue-search');
    if (!searchInput) return;
    var query = searchInput.value.toLowerCase();
    container.querySelectorAll('.pill-dropdown-option').forEach(function(label) {
        var text = label.querySelector('span').textContent.toLowerCase();
        label.style.display = text.indexOf(query) !== -1 ? '' : 'none';
    });
}

/* ========================================
   Distance filter
   ======================================== */
function setDistance(val) {
    document.getElementById('max_distance_hidden').value = val;
    if (val) {
        document.getElementById('include_online_hidden').value = '';
    }
    document.getElementById('filter-form').submit();
}

function applyCustomDistance() {
    var val = document.getElementById('custom_distance_num').value;
    var num = parseInt(val, 10);
    if (!val || isNaN(num) || num < 1) return;
    setDistance(num);
}

/* ========================================
   Toggle pills (Pony, Online)
   ======================================== */
function toggleOnlinePill(e) {
    e.preventDefault();
    var h = document.getElementById('include_online_hidden');
    h.value = h.value === 'yes' ? '' : 'yes';
    document.getElementById('filter-form').submit();
}

/* ========================================
   Event type pills
   ======================================== */
function applyEventType(e, value) {
    e.preventDefault();
    var url = new URL(window.location);
    if (value && value !== 'all') {
        url.searchParams.set('event_type', value);
    } else {
        url.searchParams.delete('event_type');
    }
    url.searchParams.delete('page');
    window.location = url.toString();
}

/* ========================================
   Sort
   ======================================== */
function applySort(value) {
    var url = new URL(window.location);
    if (value && value !== 'date_asc') {
        url.searchParams.set('sort', value);
    } else {
        url.searchParams.delete('sort');
    }
    url.searchParams.delete('page');
    window.location = url.toString();
}

/* ========================================
   Date presets
   ======================================== */
document.querySelectorAll('[data-preset]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var preset = this.dataset.preset;
        var today = new Date();
        var fromInput = document.getElementById('date_from') || document.getElementById('m-date-from');
        var toInput = document.getElementById('date_to') || document.getElementById('m-date-to');

        function fmt(d) {
            return d.getFullYear() + '-' +
                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                String(d.getDate()).padStart(2, '0');
        }

        if (preset === 'weekend') {
            var sat = new Date(today);
            var dayOfWeek = sat.getDay();
            var daysUntilSat = (6 - dayOfWeek + 7) % 7;
            if (daysUntilSat === 0 && today.getDay() === 6) daysUntilSat = 0;
            else if (daysUntilSat === 0) daysUntilSat = 7;
            if (dayOfWeek === 0) {
                sat.setDate(sat.getDate() - 1);
            } else if (dayOfWeek !== 6) {
                sat.setDate(sat.getDate() + daysUntilSat);
            }
            var sun = new Date(sat);
            sun.setDate(sun.getDate() + 1);
            fromInput.value = fmt(sat);
            toInput.value = fmt(sun);
        } else if (preset === '7days') {
            fromInput.value = fmt(today);
            var end7 = new Date(today);
            end7.setDate(end7.getDate() + 7);
            toInput.value = fmt(end7);
        } else if (preset === '30days') {
            fromInput.value = fmt(today);
            var end30 = new Date(today);
            end30.setDate(end30.getDate() + 30);
            toInput.value = fmt(end30);
        }

        /* If on desktop, submit form. On mobile, just update inputs. */
        if (window.innerWidth >= 768) {
            document.getElementById('filter-form').submit();
        }
    });
});

/* ========================================
   Location postcode edit
   ======================================== */
function toggleLocEdit(e) {
    if (e) e.preventDefault();
    var form = document.getElementById('loc-edit-form');
    form.classList.toggle('visible');
    if (form.classList.contains('visible')) {
        document.getElementById('loc-postcode-input').focus();
    }
}

async function updatePostcode() {
    var pc = document.getElementById('loc-postcode-input').value.trim();
    if (!pc) return;
    try {
        var resp = await fetch('/api/geocode?postcode=' + encodeURIComponent(pc));
        if (resp.ok) {
            localStorage.setItem('cg_postcode', pc);
            var url = new URL(window.location);
            url.searchParams.set('postcode', pc);
            url.searchParams.delete('page');
            window.location = url.toString();
        } else {
            alert('Invalid postcode');
        }
    } catch (e) {
        alert('Failed to validate postcode');
    }
}

async function useMyLocation() {
    if (!navigator.geolocation) {
        showGeoError('Geolocation not supported by this browser.');
        return;
    }
    var btn = document.getElementById('geolocate-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat" style="display:inline-block;animation:spin 1s linear infinite;"></i>';
    document.getElementById('geolocate-error').style.display = 'none';

    navigator.geolocation.getCurrentPosition(
        async function(pos) {
            try {
                var resp = await fetch('/api/geocode/reverse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lat: pos.coords.latitude, lng: pos.coords.longitude})
                });
                if (resp.ok) {
                    var data = await resp.json();
                    localStorage.setItem('cg_postcode', data.postcode);
                    var url = new URL(window.location);
                    url.searchParams.set('postcode', data.postcode);
                    url.searchParams.delete('page');
                    window.location = url.toString();
                } else {
                    var data = await resp.json().catch(function() { return {}; });
                    showGeoError(data.detail || 'Could not find a UK postcode for your location.');
                    resetGeoBtn();
                }
            } catch (e) {
                showGeoError('Request failed. Please try again.');
                resetGeoBtn();
            }
        },
        function(err) {
            var msgs = {1: 'Location access denied.', 2: 'Location unavailable.', 3: 'Location request timed out.'};
            showGeoError(msgs[err.code] || 'Location error.');
            resetGeoBtn();
        },
        {timeout: 10000, maximumAge: 60000}
    );

    function showGeoError(msg) {
        var el = document.getElementById('geolocate-error');
        el.textContent = msg; el.style.display = 'inline';
    }
    function resetGeoBtn() {
        var btn = document.getElementById('geolocate-btn');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-crosshair"></i>';
    }
}

/* ========================================
   Mobile filter drawer
   ======================================== */
function openFilterDrawer() {
    document.getElementById('filter-drawer-backdrop').classList.add('open');
    document.getElementById('filter-drawer').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeFilterDrawer() {
    document.getElementById('filter-drawer-backdrop').classList.remove('open');
    document.getElementById('filter-drawer').classList.remove('open');
    document.body.style.overflow = '';
}

function applyMobileFilters() {
    closeFilterDrawer();
    /* Sync mobile inputs to the main form and submit */
    var url = new URL(window.location.origin + '/');

    /* Dates */
    var mFrom = document.getElementById('m-date-from').value;
    var mTo = document.getElementById('m-date-to').value;
    if (mFrom) url.searchParams.set('date_from', mFrom);
    if (mTo) url.searchParams.set('date_to', mTo);

    /* Disciplines */
    document.querySelectorAll('.m-discipline-cb:checked').forEach(function(cb) {
        url.searchParams.append('discipline', cb.value);
    });

    /* Venues */
    document.querySelectorAll('.m-venue-cb:checked').forEach(function(cb) {
        url.searchParams.append('venue', cb.value);
    });

    /* Affiliations */
    document.querySelectorAll('.m-affiliation-cb:checked').forEach(function(cb) {
        url.searchParams.append('affiliation', cb.value);
    });

    /* Distance */
    var dist = document.getElementById('max_distance_hidden').value;
    if (dist) url.searchParams.set('max_distance', dist);

    /* Postcode */
    var pc = document.getElementById('postcode_hidden').value;
    if (pc) url.searchParams.set('postcode', pc);

    /* Online */
    var online = document.getElementById('include_online_hidden').value;
    if (online) url.searchParams.set('include_online', online);

    /* Event type */
    var et = '{{ event_type }}';
    if (et && et !== 'all') url.searchParams.set('event_type', et);

    /* Sort */
    var sort = '{{ sort }}';
    if (sort && sort !== 'date_asc') url.searchParams.set('sort', sort);

    window.location = url.toString();
}

function clearAllFilters() {
    closeFilterDrawer();
    var pc = localStorage.getItem('cg_postcode');
    window.location = pc ? '/?postcode=' + encodeURIComponent(pc) : '/';
}

/* Show mobile chips when on mobile */
(function() {
    if (window.innerWidth < 768) {
        var mobileChips = document.getElementById('mobile-chips');
        if (mobileChips) mobileChips.style.display = 'flex';
    }
})();

/* ========================================
   Clickable badges for filtering
   ======================================== */
function setupClickableBadges(selector, paramName, valueExtractor) {
    document.querySelectorAll(selector).forEach(function(badge) {
        badge.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            var url = new URL(window.location);
            var value = valueExtractor(this);
            var current = url.searchParams.getAll(paramName);
            if (!current.includes(value)) {
                url.searchParams.append(paramName, value);
            }
            url.searchParams.delete('page');
            window.location = url.toString();
        });
        badge.style.cursor = 'pointer';
        badge.style.opacity = '0.8';
        badge.addEventListener('mouseenter', function() { this.style.opacity = '1'; });
        badge.addEventListener('mouseleave', function() { this.style.opacity = '0.8'; });
    });
}

setupClickableBadges('.clickable-tag', 'tag', function(el) { return el.dataset.tag; });
setupClickableBadges('.badge-disc', 'discipline', function(el) { return el.textContent.trim(); });
setupClickableBadges('.badge-source', 'source', function(el) { return el.textContent.trim(); });
setupClickableBadges('.badge-venue', 'venue', function(el) { return el.dataset.venue; });

/* Calendar download buttons */
document.querySelectorAll('.badge-ical').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.location.href = this.dataset.ical;
    });
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
